<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Absensi QR Mandiri</title>
  <style>
    #preview {
      width: 100%;
      max-width: 400px;
      border: 2px solid #333;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>Absensi QR Mandiri</h2>
  <input type="text" id="npm" placeholder="NPM (hanya angka)" /><br />
  <input type="text" id="nama" placeholder="Nama Lengkap" /><br /><br />
  <button onclick="startScan()">Mulai Scan QR</button>
  <button onclick="stopScan()">Berhenti Scan</button>
  <p id="result"></p>

  <div id="preview"></div>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbzztbyAg5zUt2sxJkyVZFOWEGBAjpqOTU9sCQUtF_kYFvZbvjLbpswvSG7qEDXsuQ98/exec'; // Ganti jika diperlukan
    let html5QrCode;
    let isScanning = false;

    function getFormattedDate() {
      const now = new Date();
      return now.toISOString().replace("T", " ").substring(0, 19); // Format: YYYY-MM-DD HH:mm:ss
    }

    function startScan() {
      const npm = document.getElementById("npm").value.trim();
      const nama = document.getElementById("nama").value.trim();
      const resultEl = document.getElementById("result");

      if (!npm.match(/^\d+$/)) {
        alert("NPM harus berupa angka!");
        return;
      }

      if (!nama) {
        alert("Nama tidak boleh kosong!");
        return;
      }

      if (isScanning) return;

      html5QrCode = new Html5Qrcode("preview");
      const config = { fps: 10, qrbox: { width: 250, height: 250 } };

      isScanning = true;
      resultEl.textContent = "üì∑ Menunggu scan QR...";

      html5QrCode.start(
        { facingMode: "environment" },
        config,
        (decodedText) => {
          html5QrCode.stop().then(() => {
            isScanning = false;
            resultEl.textContent = `‚úÖ QR terbaca: ${decodedText}, mengirim...`;

            const mode = decodedText.toLowerCase(); // 'check-in' atau 'check-out'
            const waktu = getFormattedDate();

            const formData = new FormData();
            formData.append("npm", npm);
            formData.append("nama", nama);
            formData.append("mode", mode);
            formData.append("waktu", waktu);

            fetch(scriptURL, {
              method: 'POST',
              body: formData
            })
            .then(response => response.text())
            .then(msg => {
              resultEl.textContent = msg;
            })
            .catch(error => {
              resultEl.textContent = "‚ùå Gagal mengirim: " + error;
            });
          });
        },
        (errorMessage) => {
          // Tidak ditampilkan agar tidak mengganggu
        }
      );
    }

    function stopScan() {
      if (html5QrCode && isScanning) {
        html5QrCode.stop().then(() => {
          isScanning = false;
          document.getElementById("result").textContent = "üî¥ Scan dihentikan.";
        }).catch(err => {
          document.getElementById("result").textContent = "‚ùå Gagal menghentikan scan: " + err;
        });
      }
    }
  </script>
</body>
</html>
