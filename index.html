<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Absensi QR</title>
  <style>
    #preview {
      width: 100%;
      max-width: 400px;
      border: 2px solid #333;
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <h2>Absensi QR Mandiri</h2>
  <input type="text" id="npm" placeholder="NPM"><br>
  <input type="text" id="nama" placeholder="Nama"><br><br>
  <button onclick="startScan()">Scan QR</button>
  <p id="result"></p>

  <div id="preview"></div>

  <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycbx88h0OP8IGbmDtcHjicgNEQ7VCmi5AOZStOOjHpU-ki7YFCmFPSdUgc7eR5k0mUvjA/exec'; // Ganti dengan milikmu
    let html5QrCode;
    let isScanning = false;

    async function startScan() {
      const npm = document.getElementById("npm").value.trim();
      const nama = document.getElementById("nama").value.trim();
      if (!npm || !nama) {
        alert("Isi NPM dan Nama terlebih dahulu!");
        return;
      }

      const resultEl = document.getElementById("result");
      const qrRegion = document.getElementById("preview");

      if (isScanning) return;

      html5QrCode = new Html5Qrcode("preview");
      const config = { fps: 10, qrbox: { width: 250, height: 250 } };

      isScanning = true;
      resultEl.textContent = "ðŸ“· Menunggu QR...";

      await html5QrCode.start(
        { facingMode: "environment" },
        config,
        (decodedText) => {
          html5QrCode.stop().then(() => {
            isScanning = false;
            resultEl.textContent = `âœ… QR terbaca: ${decodedText} - Mengirim...`;

            const mode = decodedText.toLowerCase(); // checkin / checkout
            const waktu = new Date().toLocaleString("id-ID");

            fetch(scriptURL, {
              method: 'POST',
              body: JSON.stringify({ npm, nama, mode, waktu }),
              headers: { 'Content-Type': 'application/json' }
            })
            .then(res => res.text())
            .then(msg => {
              resultEl.textContent = msg;
            })
            .catch(err => {
              resultEl.textContent = "âŒ Gagal mengirim: " + err;
            });
          });
        },
        (errorMessage) => {
          // Bisa log error jika diperlukan
        }
      );
    }
  </script>
</body>
</html>
